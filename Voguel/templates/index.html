<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Método de Vogel (Móvil)</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding: 15px;
            margin: 0;
        }
        main {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 20px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            box-sizing: border-box;
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-top: 20px;
            word-wrap: break-word;
        }
        h1 { font-size: 1.5rem; margin-top: 0; }

        /* --- CONTROLES --- */
        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: #f1f3f5;
            padding: 15px;
            border-radius: 10px;
            justify-content: center;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        input[type="number"] {
            width: 50px;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 15px;
            text-align: center;
            font-size: 1rem;
            outline: none;
            /* Estos estilos ayudan a quitar las flechas spinner en algunos navegadores */
            appearance: textfield; 
            /* 2. Soporte específico para Firefox (necesario aunque de advertencia) */
            -moz-appearance: textfield;
        }
        /* Quitar flechas spinner en Chrome/Safari */
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            border-radius: 20px;
            cursor: pointer;
            white-space: nowrap;
            flex-grow: 1;
            max-width: 200px;
        }
        button:hover { background-color: #2980b9; }
        button:disabled { background-color: #bdc3c7; }
        button#resolver-btn { background-color: #2ecc71; }

        /* --- MATRIZ (SCROLLABLE) --- */
        .grid-scroll-wrapper {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            border: 1px solid #eee;
            border-radius: 10px;
            padding: 10px;
            box-sizing: border-box;
            background: #fafafa;
        }

        #matriz-grid {
            display: grid;
            gap: 8px;
            min-width: min-content; 
        }
        
        .grid-header, .grid-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #7f8c8d;
            background-color: #eec;
            border-radius: 8px;
            padding: 5px;
            font-size: 0.9rem;
        }
        .grid-header { background-color: #e8f6f3; color: #16a085; }
        .grid-label { background-color: #fdf2e9; color: #d35400; }

        #matriz-grid input {
            width: 60px;
        }

        /* --- RESULTADOS --- */
        .step-container {
            margin-bottom: 40px;
            background: #fff;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 20px;
        }

        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-top: 10px;
        }
        
        .step-table {
            border-collapse: collapse;
            width: 100%;
            min-width: 400px;
            font-size: 0.9rem;
        }

        .step-table th, .step-table td {
            border: 1px solid #d1d1d1;
            padding: 8px;
            text-align: center;
            white-space: nowrap;
        }

        .step-table th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: #555;
            border-bottom: 2px solid #ccc;
        }

        .cell-content {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            min-width: 20px;
        }

        .penalty-val { font-style: italic; color: #7f8c8d; font-size: 0.85rem; }

        .chosen-penalty .cell-content {
            background-color: #ffe0b2; color: #e65100; font-weight: bold;
            box-shadow: 0 2px 4px rgba(230, 81, 0, 0.2);
        }
        .chosen-cell .cell-content {
            background-color: #c8e6c9; color: #2e7d32; font-weight: bold;
            transform: scale(1.05);
            box-shadow: 0 2px 4px rgba(46, 125, 50, 0.2);
        }
        .satisfied { background-color: #f9f9f9; }
        .satisfied .cell-content { color: #ccc; text-decoration: line-through; }
        .label-cell { background-color: #f4f6f7; font-weight: bold; color: #333; border-right: 2px solid #ddd; }

        #output-log {
            background-color: #2d3436; color: #dfe6e9; padding: 15px;
            border-radius: 8px; font-family: 'Courier New', monospace;
            height: 150px; overflow-y: scroll; font-size: 0.85rem;
            white-space: pre-wrap; word-break: break-all;
        }

        @media (max-width: 600px) {
            body { padding: 10px; }
            main { padding: 15px; }
            .control-item input { width: 60px; padding: 10px; }
            .control-group { flex-direction: column; align-items: stretch; }
            button { width: 100%; max-width: none; margin-bottom: 5px; }
            h1 { font-size: 1.3rem; text-align: center; }
            h4 { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <main>
        <h1>Método de Vogel</h1>

        <section id="setup-section">
            <div class="control-group">
                <div class="control-item">
                    <label>Filas:</label>
                    <input type="number" id="filas-input" value="3" min="2" max="10" inputmode="numeric" pattern="[0-9]*">
                </div>
                <div class="control-item">
                    <label>Cols:</label>
                    <input type="number" id="columnas-input" value="4" min="2" max="10" inputmode="numeric" pattern="[0-9]*">
                </div>
                <button id="crear-tabla-btn">Generar Tabla</button>
            </div>
        </section>

        <section id="matriz-section" style="display: none;">
            <h3>Costos, Oferta y Demanda</h3>
            
            <div class="grid-scroll-wrapper">
                <div id="matriz-grid"></div>
            </div>
            
            <div class="control-group" style="margin-top: 20px; background: transparent;">
                <button id="llenar-auto-btn" style="background-color: #95a5a6;">Aleatorio</button>
                <button id="resolver-btn">Resolver</button>
            </div>
        </section>

        <section id="resultados-section" style="display: none;">
            <h3>Paso a Paso</h3>
            <div id="resultados-graficos"></div>
            
            <h3>Log</h3>
            <div id="output-log"></div>
        </section>
    </main>

    <script>
        let filas = 0, cols = 0;
        let costEntries = [], ofertaEntries = [], demandaEntries = [];

        const filasInput = document.getElementById('filas-input');
        const colsInput = document.getElementById('columnas-input');
        const crearTablaBtn = document.getElementById('crear-tabla-btn');
        const matrizSection = document.getElementById('matriz-section');
        const matrizGrid = document.getElementById('matriz-grid');
        const llenarAutoBtn = document.getElementById('llenar-auto-btn');
        const resolverBtn = document.getElementById('resolver-btn');
        const resultadosSection = document.getElementById('resultados-section');
        const stepContainer = document.getElementById('resultados-graficos');
        const outputLog = document.getElementById('output-log');

        crearTablaBtn.addEventListener('click', crearTabla);
        llenarAutoBtn.addEventListener('click', llenarAuto);
        resolverBtn.addEventListener('click', resolverVogel);

        // FUNCIÓN AUXILIAR PARA CREAR INPUTS NUMÉRICOS DE MÓVIL
        function createMobileInput() {
            const inp = document.createElement('input');
            inp.type = 'number'; 
            inp.min = '0';
            // ESTO ACTIVA EL TECLADO NUMÉRICO EN MÓVILES
            inp.setAttribute('inputmode', 'numeric');
            inp.setAttribute('pattern', '[0-9]*');
            return inp;
        }

        function crearTabla() {
            try {
                filas = parseInt(filasInput.value);
                cols = parseInt(colsInput.value);
                // Validación 2 a 10
                if (isNaN(filas) || isNaN(cols) || filas < 2 || filas > 10 || cols < 2 || cols > 10) throw new Error();
            } catch {
                alert("Ingrese números entre 2 y 10."); return;
            }

            matrizGrid.innerHTML = '';
            costEntries = []; ofertaEntries = []; demandaEntries = [];
            
            matrizGrid.style.gridTemplateColumns = `auto repeat(${cols}, auto) auto`;

            // Encabezados
            matrizGrid.appendChild(createDiv('grid-header', ''));
            for (let j = 0; j < cols; j++) matrizGrid.appendChild(createDiv('grid-header', `C${j+1}`));
            matrizGrid.appendChild(createDiv('grid-header', 'Oferta'));

            // Filas
            for (let i = 0; i < filas; i++) {
                costEntries.push([]);
                matrizGrid.appendChild(createDiv('grid-label', `F${i+1}`));
                for (let j = 0; j < cols; j++) {
                    const inp = createMobileInput(); // USAMOS LA NUEVA FUNCIÓN
                    matrizGrid.appendChild(inp);
                    costEntries[i].push(inp);
                }
                const ofInp = createMobileInput(); // USAMOS LA NUEVA FUNCIÓN
                matrizGrid.appendChild(ofInp);
                ofertaEntries.push(ofInp);
            }

            // Demanda
            matrizGrid.appendChild(createDiv('grid-label', 'Dem.'));
            for (let j = 0; j < cols; j++) {
                const demInp = createMobileInput(); // USAMOS LA NUEVA FUNCIÓN
                matrizGrid.appendChild(demInp);
                demandaEntries.push(demInp);
            }

            matrizSection.style.display = 'block';
            resultadosSection.style.display = 'none';
        }

        function createDiv(cls, txt) {
            const div = document.createElement('div');
            div.className = cls;
            div.textContent = txt;
            return div;
        }

        function llenarAuto() {
            costEntries.forEach(r => r.forEach(e => e.value = Math.floor(Math.random()*50)+1));
            ofertaEntries.forEach(e => e.value = Math.floor(Math.random()*100)+50);
            demandaEntries.forEach(e => e.value = Math.floor(Math.random()*100)+50);
        }

        async function resolverVogel() {
            resultadosSection.style.display = 'block';
            stepContainer.innerHTML = '<p>Calculando...</p>';
            
            let costos = costEntries.map(r => r.map(e => parseInt(e.value)||0));
            let oferta = ofertaEntries.map(e => parseInt(e.value)||0);
            let demanda = demandaEntries.map(e => parseInt(e.value)||0);

            try {
                const res = await fetch('/solve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({costos, oferta, demanda})
                });
                const data = await res.json();
                
                stepContainer.innerHTML = '';
                outputLog.innerHTML = data.log.join('\n');

                if(data.steps) {
                    data.steps.forEach(step => renderStep(step, data.ficticia_fila, data.ficticia_col));
                }
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function renderStep(step, fFila, fCol) {
            const [tipoPen, idxPen] = step.chosen_penalty;
            const [filaAsig, colAsig] = step.chosen_cell;
            const numFilas = step.matrix.length - 1;
            const numCols = step.matrix[0].length - 1;

            const div = document.createElement('div');
            div.className = 'step-container';
            div.innerHTML = `<h4>Paso ${step.step}: Asignar <b>${step.assigned_amount}</b> a (${filaAsig+1}, ${colAsig+1})</h4>`;

            const tableWrapper = document.createElement('div');
            tableWrapper.className = 'table-responsive';

            const table = document.createElement('table');
            table.className = 'step-table';

            // Header
            let tr = table.insertRow();
            tr.insertCell();
            for(let j=0; j<numCols; j++) {
                let th = document.createElement('th');
                th.innerText = (j === fCol) ? 'Fict' : `C${j+1}`;
                tr.appendChild(th);
            }
            let thOf = document.createElement('th'); thOf.innerText = 'Oferta'; tr.appendChild(thOf);
            let thPen = document.createElement('th'); thPen.innerText = 'Penal.'; tr.appendChild(thPen);

            // Body
            for(let i=0; i<numFilas; i++) {
                tr = table.insertRow();
                let tdLabel = tr.insertCell();
                tdLabel.className = 'label-cell';
                tdLabel.innerText = (i === fFila) ? 'Fict' : `F${i+1}`;

                for(let j=0; j<numCols; j++) {
                    let td = tr.insertCell();
                    let content = `<span class="cell-content">${step.matrix[i][j]}</span>`;
                    td.innerHTML = content;
                    if(i===filaAsig && j===colAsig) td.className = 'chosen-cell';
                    if(step.matrix[i][numCols]===0 || step.matrix[numFilas][j]===0) td.classList.add('satisfied');
                }

                let tdOferta = tr.insertCell();
                tdOferta.innerHTML = `<span class="cell-content">${step.matrix[i][numCols]}</span>`;
                if(step.matrix[i][numCols]===0) tdOferta.classList.add('satisfied');

                let tdPen = tr.insertCell();
                let val = step.row_penalties[i]===-1 ? '-' : step.row_penalties[i];
                tdPen.innerHTML = `<span class="cell-content penalty-val">${val}</span>`;
                if(tipoPen==='fila' && idxPen===i) tdPen.className = 'chosen-penalty';
            }

            // Demanda
            tr = table.insertRow();
            let tdDemLabel = tr.insertCell(); tdDemLabel.className = 'label-cell'; tdDemLabel.innerText = 'Dem.';
            for(let j=0; j<numCols; j++) {
                let td = tr.insertCell();
                td.innerHTML = `<span class="cell-content">${step.matrix[numFilas][j]}</span>`;
                if(step.matrix[numFilas][j]===0) td.classList.add('satisfied');
            }
            tr.insertCell(); tr.insertCell();

            // Penalización Columna
            tr = table.insertRow();
            let tdPenLabel = tr.insertCell(); tdPenLabel.className = 'label-cell'; tdPenLabel.innerText = 'Penal.';
            for(let j=0; j<numCols; j++) {
                let td = tr.insertCell();
                let val = step.col_penalties[j]===-1 ? '-' : step.col_penalties[j];
                td.innerHTML = `<span class="cell-content penalty-val">${val}</span>`;
                if(tipoPen==='columna' && idxPen===j) td.className = 'chosen-penalty';
            }
            tr.insertCell(); tr.insertCell();

            tableWrapper.appendChild(table);
            div.appendChild(tableWrapper);
            stepContainer.appendChild(div);
        }
    </script>
</body>
</html>