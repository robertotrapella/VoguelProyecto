<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Método de Vogel (Gráfico)</title>
    <style>
        /* --- ESTILOS GENERALES (Estética Suave) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        main {
            background-color: #ffffff;
            border-radius: 12px; /* Bordes redondeados del contenedor principal */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
            margin-top: 30px;
        }
        h1 { margin-top: 0; }

        /* --- CONTROLES --- */
        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            background: #f1f3f5;
            padding: 15px;
            border-radius: 10px;
        }
        .control-group label { font-weight: 600; color: #555; }
        
        /* Inputs redondeados y suaves */
        input[type="number"] {
            width: 60px;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 20px; /* Bordes muy redondeados (píldora) */
            text-align: center;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus {
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 0.95rem;
            font-weight: 600;
            border-radius: 20px; /* Botones redondeados */
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
        }
        button:hover { background-color: #2980b9; transform: translateY(-1px); }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; transform: none; }
        button#resolver-btn { background-color: #2ecc71; }
        button#resolver-btn:hover { background-color: #27ae60; }

        /* --- 1. MATRIZ DE INPUTS --- */
        #matriz-grid {
            display: grid;
            gap: 10px; /* Espacio entre las cajitas */
            margin-top: 20px;
            justify-content: start;
            padding: 20px;
            border: 1px dashed #ccc; /* Línea guía exterior sutil */
            border-radius: 10px;
            background-color: #fafafa;
            overflow-x: auto;
        }
        
        .grid-header, .grid-label {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #7f8c8d;
            background-color: #eec; /* Un colorcito suave para las etiquetas */
            border-radius: 8px;
            padding: 5px;
            min-width: 40px;
        }
        .grid-header { background-color: #e8f6f3; color: #16a085; } /* Color diferente para columnas */
        .grid-label { background-color: #fdf2e9; color: #d35400; } /* Color diferente para filas */

        /* --- 2. TABLAS DE RESULTADOS (LAS LÍNEAS) --- */
        .step-container {
            margin-bottom: 50px;
            background: #fff;
            padding: 10px;
        }
        
        .step-table {
            border-collapse: collapse; /* Une las líneas */
            width: 100%;
            margin-top: 15px;
            font-size: 0.95rem;
        }

        /* LAS LÍNEAS QUE PIDIÓ: Separadores grises sutiles */
        .step-table th, .step-table td {
            border: 1px solid #d1d1d1; /* Líneas visibles pero no agresivas */
            padding: 12px;
            text-align: center;
            vertical-align: middle;
        }

        .step-table th {
            background-color: #f8f9fa;
            font-weight: 700;
            color: #555;
            border-bottom: 2px solid #ccc; /* Línea un poco más gruesa bajo el encabezado */
        }

        /* --- ESTÉTICA DE CELDAS (Lo "redondo" dentro de las líneas) --- */
        
        /* Contenedor interno para dar el efecto redondeado al contenido */
        .cell-content {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 15px; /* Aquí está el borde circular que querías */
            min-width: 30px;
        }

        /* Penalización (Número pequeño) */
        .penalty-val {
            font-style: italic;
            color: #7f8c8d;
        }

        /* --- Colores de Acción --- */
        
        /* Penalización Elegida (Burbuja Naranja) */
        .chosen-penalty .cell-content {
            background-color: #ffe0b2;
            color: #e65100;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(230, 81, 0, 0.2);
        }

        /* Celda Asignada (Burbuja Verde) */
        .chosen-cell .cell-content {
            background-color: #c8e6c9;
            color: #2e7d32;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(46, 125, 50, 0.2);
            transform: scale(1.1); /* Un poquito más grande */
        }

        /* Filas/Cols Tachadas */
        .satisfied {
            background-color: #f9f9f9; /* Fondo muy suave para lo tachado */
        }
        .satisfied .cell-content {
            color: #bbb;
            text-decoration: line-through;
        }

        /* Etiquetas laterales en la tabla */
        .label-cell {
            background-color: #f4f6f7;
            font-weight: bold;
            color: #333;
            border-right: 2px solid #ddd; /* Línea separadora vertical */
        }

        #output-log {
            background-color: #2d3436;
            color: #dfe6e9;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            height: 200px;
            overflow-y: scroll;
            line-height: 1.5;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <main>
        <h1>Método de Vogel</h1>

        <section id="setup-section">
            <div class="control-group">
                <label>Filas:</label>
                <input type="number" id="filas-input" value="3" min="2" max="10">
                <label>Columnas:</label>
                <input type="number" id="columnas-input" value="4" min="2" max="10">
                <button id="crear-tabla-btn">Generar Tabla</button>
            </div>
        </section>

        <section id="matriz-section" style="display: none;">
            <h3>Ingrese los Costos</h3>
            <div id="matriz-grid"></div>
            
            <div class="control-group" style="margin-top: 20px; background: transparent;">
                <button id="llenar-auto-btn" style="background-color: #95a5a6;">Llenar Aleatorio</button>
                <button id="resolver-btn">Resolver Paso a Paso</button>
            </div>
        </section>

        <section id="resultados-section" style="display: none;">
            <h3>Visualización del Algoritmo</h3>
            <div id="resultados-graficos"></div>
            
            <h3>Resumen de Operaciones</h3>
            <div id="output-log"></div>
        </section>
    </main>

    <script>
        // --- Variables ---
        let filas = 0, cols = 0;
        let costEntries = [], ofertaEntries = [], demandaEntries = [];

        // --- DOM Elements ---
        const filasInput = document.getElementById('filas-input');
        const colsInput = document.getElementById('columnas-input');
        const crearTablaBtn = document.getElementById('crear-tabla-btn');
        const matrizSection = document.getElementById('matriz-section');
        const matrizGrid = document.getElementById('matriz-grid');
        const llenarAutoBtn = document.getElementById('llenar-auto-btn');
        const resolverBtn = document.getElementById('resolver-btn');
        const resultadosSection = document.getElementById('resultados-section');
        const stepContainer = document.getElementById('resultados-graficos');
        const outputLog = document.getElementById('output-log');

        // --- Listeners ---
        crearTablaBtn.addEventListener('click', crearTabla);
        llenarAutoBtn.addEventListener('click', llenarAuto);
        resolverBtn.addEventListener('click', resolverVogel);

        function crearTabla() {
            try {
                filas = parseInt(filasInput.value);
                cols = parseInt(colsInput.value);
                if (isNaN(filas) || isNaN(cols) || filas < 1 || filas > 5 || cols < 1 || cols > 5) throw new Error();
            } catch {
                alert("Ingrese números entre 1 y 5."); return;
            }

            matrizGrid.innerHTML = '';
            costEntries = []; ofertaEntries = []; demandaEntries = [];
            
            // Grid Layout Dinámico
            matrizGrid.style.gridTemplateColumns = `auto repeat(${cols}, auto) auto`;

            // Encabezados
            matrizGrid.appendChild(createDiv('grid-header', ''));
            for (let j = 0; j < cols; j++) matrizGrid.appendChild(createDiv('grid-header', `C${j+1}`));
            matrizGrid.appendChild(createDiv('grid-header', 'Oferta'));

            // Filas
            for (let i = 0; i < filas; i++) {
                costEntries.push([]);
                matrizGrid.appendChild(createDiv('grid-label', `F${i+1}`));
                for (let j = 0; j < cols; j++) {
                    const inp = document.createElement('input');
                    inp.type = 'number'; inp.min = '0';
                    matrizGrid.appendChild(inp);
                    costEntries[i].push(inp);
                }
                const ofInp = document.createElement('input');
                ofInp.type = 'number'; ofInp.min = '0';
                matrizGrid.appendChild(ofInp);
                ofertaEntries.push(ofInp);
            }

            // Demanda
            matrizGrid.appendChild(createDiv('grid-label', 'Demanda'));
            for (let j = 0; j < cols; j++) {
                const demInp = document.createElement('input');
                demInp.type = 'number'; demInp.min = '0';
                matrizGrid.appendChild(demInp);
                demandaEntries.push(demInp);
            }

            matrizSection.style.display = 'block';
            resultadosSection.style.display = 'none';
        }

        function createDiv(cls, txt) {
            const div = document.createElement('div');
            div.className = cls;
            div.textContent = txt;
            return div;
        }

        function llenarAuto() {
            costEntries.forEach(r => r.forEach(e => e.value = Math.floor(Math.random()*50)+1));
            ofertaEntries.forEach(e => e.value = Math.floor(Math.random()*100)+50);
            demandaEntries.forEach(e => e.value = Math.floor(Math.random()*100)+50);
        }

        async function resolverVogel() {
            resultadosSection.style.display = 'block';
            stepContainer.innerHTML = '<p>Calculando...</p>';
            
            let costos = costEntries.map(r => r.map(e => parseInt(e.value)||0));
            let oferta = ofertaEntries.map(e => parseInt(e.value)||0);
            let demanda = demandaEntries.map(e => parseInt(e.value)||0);

            try {
                const res = await fetch('/solve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({costos, oferta, demanda})
                });
                const data = await res.json();
                
                stepContainer.innerHTML = '';
                outputLog.innerHTML = data.log.join('\n');

                if(data.steps) {
                    data.steps.forEach(step => renderStep(step, data.ficticia_fila, data.ficticia_col));
                }
            } catch (e) {
                alert("Error: " + e.message);
            }
        }

        function renderStep(step, fFila, fCol) {
            const [tipoPen, idxPen] = step.chosen_penalty;
            const [filaAsig, colAsig] = step.chosen_cell;
            const numFilas = step.matrix.length - 1;
            const numCols = step.matrix[0].length - 1;

            const div = document.createElement('div');
            div.className = 'step-container';
            div.innerHTML = `<h4>Paso ${step.step}: Asignar <b>${step.assigned_amount}</b> a (${filaAsig+1}, ${colAsig+1})</h4>`;

            const table = document.createElement('table');
            table.className = 'step-table';

            // Header
            let tr = table.insertRow();
            tr.insertCell();
            for(let j=0; j<numCols; j++) {
                let th = document.createElement('th');
                th.innerText = (j === fCol) ? 'Fict' : `C${j+1}`;
                tr.appendChild(th);
            }
            let thOf = document.createElement('th'); thOf.innerText = 'Oferta'; tr.appendChild(thOf);
            let thPen = document.createElement('th'); thPen.innerText = 'Penal.'; tr.appendChild(thPen);

            // Body
            for(let i=0; i<numFilas; i++) {
                tr = table.insertRow();
                // Label Fila
                let tdLabel = tr.insertCell();
                tdLabel.className = 'label-cell';
                tdLabel.innerText = (i === fFila) ? 'Fict' : `F${i+1}`;

                // Costos
                for(let j=0; j<numCols; j++) {
                    let td = tr.insertCell();
                    let content = `<span class="cell-content">${step.matrix[i][j]}</span>`;
                    td.innerHTML = content;

                    if(i===filaAsig && j===colAsig) td.className = 'chosen-cell';
                    if(step.matrix[i][numCols]===0 || step.matrix[numFilas][j]===0) td.classList.add('satisfied');
                }

                // Oferta
                let tdOferta = tr.insertCell();
                tdOferta.innerHTML = `<span class="cell-content">${step.matrix[i][numCols]}</span>`;
                if(step.matrix[i][numCols]===0) tdOferta.classList.add('satisfied');

                // Penalización Fila
                let tdPen = tr.insertCell();
                let val = step.row_penalties[i]===-1 ? '-' : step.row_penalties[i];
                tdPen.innerHTML = `<span class="cell-content penalty-val">${val}</span>`;
                if(tipoPen==='fila' && idxPen===i) tdPen.className = 'chosen-penalty';
            }

            // Demanda
            tr = table.insertRow();
            let tdDemLabel = tr.insertCell(); tdDemLabel.className = 'label-cell'; tdDemLabel.innerText = 'Dem.';
            for(let j=0; j<numCols; j++) {
                let td = tr.insertCell();
                td.innerHTML = `<span class="cell-content">${step.matrix[numFilas][j]}</span>`;
                if(step.matrix[numFilas][j]===0) td.classList.add('satisfied');
            }
            tr.insertCell(); tr.insertCell();

            // Penalización Columna
            tr = table.insertRow();
            let tdPenLabel = tr.insertCell(); tdPenLabel.className = 'label-cell'; tdPenLabel.innerText = 'Penal.';
            for(let j=0; j<numCols; j++) {
                let td = tr.insertCell();
                let val = step.col_penalties[j]===-1 ? '-' : step.col_penalties[j];
                td.innerHTML = `<span class="cell-content penalty-val">${val}</span>`;
                if(tipoPen==='columna' && idxPen===j) td.className = 'chosen-penalty';
            }
            tr.insertCell(); tr.insertCell();

            div.appendChild(table);
            stepContainer.appendChild(div);
        }
    </script>
</body>
</html>
